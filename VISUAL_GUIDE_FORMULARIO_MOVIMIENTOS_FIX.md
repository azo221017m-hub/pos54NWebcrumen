# Visual Guide: FormularioMovimientos 404 Fix

## Problem Visualization

### Before Fix: Error Flow ๐ด

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  FormularioMovimientos Component                                โ
โ  User clicks "SOLICITAR" button                                 โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  movimientosService.ts (OLD - BROKEN)                           โ
โ                                                                  โ
โ  const API_URL = import.meta.env.VITE_API_URL ||                โ
โ                  'http://localhost:3000/api'                    โ
โ                                                                  โ
โ  Issue: In production, VITE_API_URL might be:                   โ
โ  - Not set โ uses fallback with /api                            โ
โ  - Set without /api โ URL construction fails                    โ
โ  - Set with /api โ double /api// in URL                         โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Axios Request                                                   โ
โ  POST https://pos54nwebcrumen.onrender.com/api/api/movimientos  โ
โ  OR                                                              โ
โ  POST https://pos54nwebcrumen.onrender.com/movimientos          โ
โ  (wrong URL - missing /api)                                     โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Backend Response                                                โ
โ  โ 404 Not Found                                                โ
โ  Endpoint does not exist                                         โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  User Sees Error                                                 โ
โ  โ "Error al guardar movimiento: AxiosError 404"               โ
โ  โ No database insert                                           โ
โ  โ No movement created                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### After Fix: Success Flow ๐ข

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  FormularioMovimientos Component                                โ
โ  User clicks "SOLICITAR" button                                 โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  movimientosService.ts (NEW - FIXED)                            โ
โ                                                                  โ
โ  import apiClient from './api'                                  โ
โ  const API_BASE = '/movimientos'                                โ
โ                                                                  โ
โ  apiClient.post(API_BASE, movimiento)                           โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  apiClient (Centralized Client)                                 โ
โ                                                                  โ
โ  baseURL: config.apiUrl                                         โ
โ  (Correctly configured: VITE_API_URL + '/api')                  โ
โ                                                                  โ
โ  Interceptor adds: Authorization: Bearer <token>                โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Axios Request                                                   โ
โ  โ POST https://pos54nwebcrumen.onrender.com/api/movimientos   โ
โ  (correct URL)                                                   โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Backend Response                                                โ
โ  โ 201 Created                                                  โ
โ  { success: true, data: { ...movimiento } }                     โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  User Sees Success                                               โ
โ  โ "Movimiento creado correctamente"                           โ
โ  โ Database insert completed                                    โ
โ  โ Movement appears in list                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Code Comparison

### Before: Manual Axios Configuration โ

```typescript
// src/services/movimientosService.ts (OLD)

import axios from 'axios';

// โ PROBLEM: Hardcoded /api in fallback
const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000/api';

// โ PROBLEM: Manual header management
const getAuthHeaders = () => {
  const token = localStorage.getItem('token');
  return {
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  };
};

// โ PROBLEM: Full URL construction + manual headers
export const crearMovimiento = async (movimiento: MovimientoCreate) => {
  const response = await axios.post(
    `${API_URL}/movimientos`,  // โ URL construction issue
    movimiento,
    getAuthHeaders()            // โ Manual headers
  );
  return response.data.data;
};
```

**Issues:**
1. โ Inconsistent URL construction between environments
2. โ Manual token management (prone to errors)
3. โ No centralized error handling
4. โ Duplicated auth logic across services

### After: Centralized API Client โ

```typescript
// src/services/movimientosService.ts (NEW)

import apiClient from './api';

// โ SOLUTION: Relative path only
const API_BASE = '/movimientos';

// โ SOLUTION: Use centralized client (no manual headers needed)
export const crearMovimiento = async (movimiento: MovimientoCreate) => {
  const response = await apiClient.post<MovimientoResponse>(
    API_BASE,        // โ Simple relative path
    movimiento       // โ No manual headers needed
  );
  if (!response.data.data) {
    throw new Error('No se pudo crear el movimiento');
  }
  return response.data.data;
};
```

**Benefits:**
1. โ Consistent URL construction via centralized config
2. โ Automatic token injection via interceptors
3. โ Centralized error handling (auto-logout on 401)
4. โ Consistent with all other services

## Architecture Diagram

### Old Architecture (Fragmented) โ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Component Layer                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  FormularioMovimiento                                            โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Service Layer (INCONSISTENT)                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  movimientosService.ts  โ  axios (manual config) โ              โ
โ  insumosService.ts      โ  apiClient โ                          โ
โ  proveedoresService.ts  โ  apiClient โ                          โ
โ  ventasWebService.ts    โ  apiClient โ                          โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Network Layer                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  Multiple axios instances, inconsistent configuration            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### New Architecture (Unified) โ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Component Layer                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  FormularioMovimiento                                            โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Service Layer (CONSISTENT)                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  movimientosService.ts  โ  apiClient โ                          โ
โ  insumosService.ts      โ  apiClient โ                          โ
โ  proveedoresService.ts  โ  apiClient โ                          โ
โ  ventasWebService.ts    โ  apiClient โ                          โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  API Client Layer (CENTRALIZED)                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  apiClient (src/services/api.ts)                                โ
โ  - Centralized config                                            โ
โ  - Request interceptor (auto-add JWT)                            โ
โ  - Response interceptor (auto-logout on 401)                     โ
โ  - Consistent error handling                                     โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Network Layer                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  Single axios instance, consistent configuration                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## User Interface Impact

### Before: Error State โ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Movimientos de Inventario                            [X]       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                 โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ โ โ Error al guardar movimiento: AxiosError 404          โ   โ
โ โ    Request failed with status code 404                  โ   โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                 โ
โ Motivo: [COMPRA โผ]                    [SOLICITAR] [APLICAR]   โ
โ                                                                 โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ โ INSUMO | CANT. | COSTO | PROVEEDOR | U.M. | EXIST. |   โ   โ
โ โ Harina | 10    | 5.00   | Provee SA | KG   | 100     |   โ   โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                 โ
โ โ No se guardรณ en la base de datos                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### After: Success State โ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Movimientos de Inventario                            [X]       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                 โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ โ โ Movimiento creado correctamente                       โ   โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                 โ
โ Lista de Movimientos:                                           โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ โ #  | Fecha      | Motivo  | Observaciones    | Estado  โ   โ
โ โ 45 | 2026-02-08 | COMPRA  | Compra mensual   | PEND.   โ   โ
โ โ 44 | 2026-02-07 | MERMA   | Producto vencido | APLIC.  โ   โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                 โ
โ โ Movimiento guardado en la base de datos                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Configuration Files

### api.config.ts (Centralized Configuration)

```typescript
// src/config/api.config.ts

// โ Proper URL construction with /api added
const API_BASE_URL = import.meta.env.VITE_API_URL 
  ? `${import.meta.env.VITE_API_URL}/api`
  : 'http://localhost:3000/api';

export const config = {
  apiUrl: API_BASE_URL,
  timeout: 10000,
  // ... other config
};
```

### Environment Variables

**Development (.env)**
```env
VITE_API_URL=http://localhost:3000
```
โ Results in: `http://localhost:3000/api`

**Production (Render)**
```env
VITE_API_URL=https://pos54nwebcrumen.onrender.com
```
โ Results in: `https://pos54nwebcrumen.onrender.com/api`

## Testing Scenarios

### Test Case 1: Create Movement with COMPRA โ
```
1. Login to application
2. Navigate to "Movimientos de Inventario"
3. Click "Nuevo Movimiento"
4. Select motivo: "COMPRA"
5. Click "+ INSUMO"
6. Select insumo: "Harina"
7. Enter cantidad: 10
8. Enter costo: 5.00
9. Select proveedor: "Provee SA"
10. Click "SOLICITAR"

Expected Result:
โ Success message: "Movimiento creado correctamente"
โ Movement appears in list with status "PENDIENTE"
โ No 404 error in console
โ Database record created in tblposcrumenwebmovimientos
```

### Test Case 2: Create Movement with MERMA โ
```
1. Login to application
2. Navigate to "Movimientos de Inventario"
3. Click "Nuevo Movimiento"
4. Select motivo: "MERMA"
5. Add insumo details
6. Click "SOLICITAR"

Expected Result:
โ Success message appears
โ Movement created with tipomovimiento = "SALIDA"
โ No errors
```

### Test Case 3: Validation Error โ
```
1. Login to application
2. Navigate to "Movimientos de Inventario"
3. Click "Nuevo Movimiento"
4. Click "+ INSUMO" but leave fields empty
5. Click "SOLICITAR"

Expected Result:
โ Validation error: "Todos los insumos deben tener..."
โ No API call made
โ No 404 error
```

## Monitoring

### Key Metrics to Monitor
1. **Error Rate**: Should decrease from 100% to 0% on SOLICITAR clicks
2. **API Success Rate**: POST /api/movimientos should succeed
3. **User Complaints**: Should decrease regarding inventory movements
4. **Database Inserts**: Should start occurring for movimientos

### Log Patterns

**Before (Error Logs):**
```
Error al crear movimiento: AxiosError: Request failed with status code 404
POST /api/api/movimientos 404
```

**After (Success Logs):**
```
POST /api/movimientos 201
Movimiento creado exitosamente
```

## Rollout Plan

### Phase 1: Deployment โ
1. Merge PR to main
2. Deploy to production
3. Monitor error logs

### Phase 2: Verification (Manual) ๐
1. Test SOLICITAR button
2. Verify database inserts
3. Check user feedback

### Phase 3: Monitoring (24h) ๐
1. Monitor error rates
2. Check success metrics
3. Gather user feedback

### Phase 4: Closure โณ
1. Confirm fix successful
2. Close GitHub issue
3. Update documentation

---

**Status**: โ Code Complete, Ready for Deployment
**Last Updated**: 2026-02-08
